<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Ordering - Client</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { padding-top: 70px; background: #f8f9fa; }
        .navbar-brand { font-weight: bold; font-size: 1.5rem; }
        .food-card { 
            margin-bottom: 20px; 
            transition: transform 0.2s;
            cursor: pointer;
        }
        .food-card:hover { transform: translateY(-5px); }
        .food-card img { height: 200px; object-fit: cover; }
        .cart-badge { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: red;
            color: white;
            border-radius: 50%;
            padding: 5px 8px;
            font-size: 12px;
        }
        .category-chip { 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .category-chip:hover { transform: scale(1.05); }
        .category-chip.active { 
            background: #0d6efd !important; 
            color: white !important;
        }
        #loginPage, #mainApp { display: none; }
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        .order-card {
            border-left: 4px solid #0d6efd;
            margin-bottom: 15px;
        }
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .status-in_process { background: #ffc107; color: #000; }
        .status-ready { background: #17a2b8; color: #fff; }
        .status-delivered { background: #28a745; color: #fff; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-utensils"></i> FoodHub</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('home')"><i class="fas fa-home"></i> Home</a></li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="#" onclick="showPage('cart')">
                            <i class="fas fa-shopping-cart"></i> Cart
                            <span class="cart-badge" id="cartBadge" style="display:none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('orders')"><i class="fas fa-receipt"></i> Orders</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showPage('account')"><i class="fas fa-user"></i> Account</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login/Register Page -->
    <div id="loginPage" class="container">
        <div class="row justify-content-center" style="margin-top: 100px;">
            <div class="col-md-5">
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="fas fa-utensils fa-3x text-primary"></i>
                            <h3 class="mt-3">Welcome to FoodHub</h3>
                            <p class="text-muted">Your favorite meals, delivered!</p>
                        </div>
                        
                        <!-- Login Form -->
                        <div id="loginForm">
                            <h5 class="mb-3">Login</h5>
                            <form id="loginFormSubmit">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-user"></i> Username</label>
                                    <input type="text" class="form-control" id="loginUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-lock"></i> Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 mb-3">Login</button>
                            </form>
                            <div class="text-center">
                                <small>Don't have an account? <a href="#" onclick="toggleAuthForm()">Register here</a></small>
                            </div>
                        </div>

                        <!-- Register Form -->
                        <div id="registerForm" style="display:none;">
                            <h5 class="mb-3">Register</h5>
                            <form id="registerFormSubmit">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="regUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="regPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="regName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="regPhone" required>
                                </div>
                                <button type="submit" class="btn btn-success w-100 mb-3">Register</button>
                            </form>
                            <div class="text-center">
                                <small>Already have an account? <a href="#" onclick="toggleAuthForm()">Login here</a></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="container">
        <!-- Home Page -->
        <div id="homePage" class="page">
            <div class="hero-section text-center">
                <h1><i class="fas fa-pizza-slice"></i> Delicious Food at Your Doorstep</h1>
                <p class="lead">Browse our menu and order your favorite meals</p>
            </div>

            <!-- Search Bar -->
            <div class="row mb-4">
                <div class="col-md-8 mx-auto">
                    <div class="input-group input-group-lg shadow-sm">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search for food...">
                    </div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="text-center mb-4">
                <span class="badge bg-light text-dark category-chip active me-2" onclick="filterCategory('', this)">
                    <i class="fas fa-th"></i> All
                </span>
                <span class="badge bg-light text-dark category-chip me-2" onclick="filterCategory('Breakfast', this)">
                    <i class="fas fa-coffee"></i> Breakfast
                </span>
                <span class="badge bg-light text-dark category-chip me-2" onclick="filterCategory('Lunch', this)">
                    <i class="fas fa-hamburger"></i> Lunch
                </span>
                <span class="badge bg-light text-dark category-chip" onclick="filterCategory('Snacks', this)">
                    <i class="fas fa-cookie"></i> Snacks
                </span>
            </div>

            <!-- Food Items -->
            <div id="foodsList" class="row"></div>
        </div>

        <!-- Cart Page -->
        <div id="cartPage" class="page" style="display:none;">
            <h2 class="mb-4"><i class="fas fa-shopping-cart"></i> Shopping Cart</h2>
            <div class="row">
                <div class="col-md-8">
                    <div id="cartItems"></div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm sticky-top" style="top: 100px;">
                        <div class="card-body">
                            <h5>Order Summary</h5>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Delivery Fee:</span>
                                <span>$2.99</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong id="cartTotal">$0.00</strong>
                            </div>
                            <button class="btn btn-primary w-100 btn-lg" onclick="checkout()">
                                <i class="fas fa-check"></i> Checkout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div id="ordersPage" class="page" style="display:none;">
            <h2 class="mb-4"><i class="fas fa-receipt"></i> My Orders</h2>
            <div id="ordersList"></div>
        </div>

        <!-- Account Page -->
        <div id="accountPage" class="page" style="display:none;">
            <h2 class="mb-4"><i class="fas fa-user-circle"></i> Account Settings</h2>
            <div class="row">
                <div class="col-md-6 mx-auto">
                    <div class="card shadow-sm">
                        <div class="card-body p-4">
                            <form id="accountForm">
                                <div class="mb-3">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="accountUsername" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="accountName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="accountPhone" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">New Password (leave blank to keep current)</label>
                                    <input type="password" class="form-control" id="accountPassword">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save"></i> Update Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
const API_BASE = 'http://localhost:8000/api';
let token = null;
let currentCategory = '';
let cart = [];
let currentUser = null;

// ============ Cart Management ============
function addToCart(food) {
    const existing = cart.find(item => item.id === food.id);
    if (existing) {
        existing.quantity++;
    } else {
        cart.push({
            id: food.id,
            name: food.name,
            price: food.price,
            quantity: 1,
            image_url: food.image_url
        });
    }
    updateCartBadge();
    showToast('Added to cart!', 'success');
}

function removeFromCart(foodId) {
    cart = cart.filter(item => item.id !== foodId);
    updateCartBadge();
    displayCart();
}

function updateQuantity(foodId, delta) {
    const item = cart.find(item => item.id === foodId);
    if (item) {
        item.quantity += delta;
        if (item.quantity <= 0) {
            removeFromCart(foodId);
        } else {
            displayCart();
            updateCartBadge();
        }
    }
}

function getCartTotal() {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
}

function updateCartBadge() {
    const badge = document.getElementById('cartBadge');
    const count = cart.length;
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'block';
    } else {
        badge.style.display = 'none';
    }
}

// ============ Authentication ============
window.addEventListener('DOMContentLoaded', () => {
    token = localStorage.getItem('clientToken');
    if (token) {
        currentUser = JSON.parse(localStorage.getItem('clientUser'));
        document.getElementById('mainApp').style.display = 'block';
        loadHome();
    } else {
        document.getElementById('loginPage').style.display = 'block';
    }
});

function toggleAuthForm() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
    } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
    }
}

document.getElementById('loginFormSubmit').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;

    try {
        const res = await fetch(`${API_BASE}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (res.ok) {  // ✅ FIXED: Removed role check
            token = data.token;
            currentUser = data.user;
            localStorage.setItem('clientToken', token);
            localStorage.setItem('clientUser', JSON.stringify(currentUser));
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadHome();
            showToast('Login successful!', 'success');
        } else {
            showToast('Login failed', 'error');
        }
    } catch (err) {
        showToast('Login failed', 'error');
    }
});

document.getElementById('registerFormSubmit').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
        username: document.getElementById('regUsername').value,
        password: document.getElementById('regPassword').value,
        name: document.getElementById('regName').value,
        phone: document.getElementById('regPhone').value
    };

    console.log("🔍 DEBUG: Sending registration data:", data);

    try {
        const res = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const responseData = await res.json();
        console.log("🔍 DEBUG: Server response:", responseData);

        if (res.ok) {
            showToast('Registration successful! Please login.', 'success');
            toggleAuthForm();
        } else {
            showToast(`Registration failed: ${responseData.message}`, 'error');
        }
    } catch (err) {
        console.error("🔍 DEBUG: Registration error:", err);
        showToast('Registration failed: ' + err.message, 'error');
    }
});

function logout() {
    localStorage.removeItem('clientToken');
    localStorage.removeItem('clientUser');
    token = null;
    currentUser = null;
    cart = [];
    document.getElementById('mainApp').style.display = 'none';
    document.getElementById('loginPage').style.display = 'block';
    showToast('Logged out successfully', 'success');
}

// ============ Page Navigation ============
function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(page + 'Page').style.display = 'block';

    if (page === 'home') loadHome();
    else if (page === 'cart') displayCart();
    else if (page === 'orders') loadOrders();
    else if (page === 'account') loadAccount();
}

// ============ Load Home ============
async function loadHome() {
    const search = document.getElementById('searchInput')?.value || '';
    const url = `${API_BASE}/foods?category=${currentCategory}&search=${search}`;
    const res = await fetch(url);
    const foods = await res.json();

    const html = foods.map(f => `
        <div class="col-md-4 col-lg-3">
            <div class="card food-card shadow-sm">
                <img src="${f.image_url}" class="card-img-top" alt="${f.name}">
                <div class="card-body">
                    <h5 class="card-title">${f.name}</h5>
                    <p class="card-text text-muted small">${f.description}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="text-primary mb-0">$${f.price.toFixed(2)}</h4>
                        <button class="btn btn-primary btn-sm" onclick='addToCart(${JSON.stringify(f)})'>
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <small class="badge bg-secondary mt-2">${f.category}</small>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('foodsList').innerHTML = html || '<div class="col-12 text-center"><p>No foods found</p></div>';
}

document.getElementById('searchInput')?.addEventListener('input', loadHome);

function filterCategory(category, element) {
    currentCategory = category;
    document.querySelectorAll('.category-chip').forEach(chip => chip.classList.remove('active'));
    element.classList.add('active');
    loadHome();
}

// ============ Display Cart ============
function displayCart() {
    if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-3"></i>
                <h4>Your cart is empty</h4>
                <button class="btn btn-primary mt-3" onclick="showPage('home')">Browse Menu</button>
            </div>
        `;
        document.getElementById('cartSubtotal').textContent = '$0.00';
        document.getElementById('cartTotal').textContent = '$2.99';
        return;
    }

    const html = cart.map(item => `
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <img src="${item.image_url}" class="img-fluid rounded" alt="${item.name}">
                    </div>
                    <div class="col-md-4">
                        <h5>${item.name}</h5>
                        <p class="text-muted mb-0">$${item.price.toFixed(2)} each</p>
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <button class="btn btn-outline-secondary" disabled>${item.quantity}</button>
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <h5 class="text-primary">$${(item.price * item.quantity).toFixed(2)}</h5>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('cartItems').innerHTML = html;
    const subtotal = getCartTotal();
    document.getElementById('cartSubtotal').textContent = '$' + subtotal.toFixed(2);
    document.getElementById('cartTotal').textContent = '$' + (subtotal + 2.99).toFixed(2);
}

// ============ Checkout ============
async function checkout() {
    if (cart.length === 0) {
        showToast('Cart is empty', 'error');
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/orders`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                items: cart,
                total_price: getCartTotal()
            })
        });

        if (res.ok) {
            cart = [];
            updateCartBadge();
            showToast('Order placed successfully!', 'success');
            showPage('orders');
        } else {
            showToast('Checkout failed', 'error');
        }
    } catch (err) {
        showToast('Checkout failed', 'error');
    }
}

// ============ Load Orders ============
async function loadOrders() {
    try {
        const res = await fetch(`${API_BASE}/orders`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const orders = await res.json();

        if (orders.length === 0) {
            document.getElementById('ordersList').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-receipt fa-4x text-muted mb-3"></i>
                    <h4>No orders yet</h4>
                </div>
            `;
            return;
        }

        const html = orders.map(o => `
            <div class="card order-card shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5>Order #${o.id}</h5>
                            <small class="text-muted">${o.created_at}</small>
                        </div>
                        <span class="status-badge status-${o.status}">${o.status.toUpperCase().replace('_', ' ')}</span>
                    </div>
                    <p><strong>Items:</strong> ${o.items.map(i => `${i.name} (x${i.quantity})`).join(', ')}</p>
                    <h5 class="text-primary">Total: $${o.total_price.toFixed(2)}</h5>
                </div>
            </div>
        `).join('');

        document.getElementById('ordersList').innerHTML = html;
    } catch (err) {
        showToast('Failed to load orders', 'error');
    }
}

// ============ Load Account ============
async function loadAccount() {
    try {
        const res = await fetch(`${API_BASE}/account`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const user = await res.json();

        document.getElementById('accountUsername').value = user.username;
        document.getElementById('accountName').value = user.name;
        document.getElementById('accountPhone').value = user.phone;
    } catch (err) {
        showToast('Failed to load account', 'error');
    }
}

document.getElementById('accountForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        name: document.getElementById('accountName').value,
        phone: document.getElementById('accountPhone').value,
        password: document.getElementById('accountPassword').value
    };

    try {
        const res = await fetch(`${API_BASE}/account`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            showToast('Account updated successfully', 'success');
            document.getElementById('accountPassword').value = '';
        } else {
            showToast('Update failed', 'error');
        }
    } catch (err) {
        showToast('Update failed', 'error');
    }
});

// ============ Toast Notifications ============
function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0 position-fixed bottom-0 end-0 m-3" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    const toastEl = document.querySelector('.toast:last-child');
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    setTimeout(() => toastEl.remove(), 3000);
}
    </script>
</body>
</html>
